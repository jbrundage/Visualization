<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>DataPatterns Viz 1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script src="../../../packages/util/dist/index.js"></script>
    <script src="../../../packages/common/dist/index.js"></script>
    <script src="../../../packages/api/dist/index.js"></script>
    <script src="../../../packages/dgrid-shim/dist/index.js"></script>
    <script src="../../../packages/dgrid/dist/index.js"></script>
    <script src="../../../packages/html/dist/index.js"></script>
    <script src="../../../packages/chart/dist/index.js"></script>
    <script src="../../../packages/other/dist/index.js"></script>
    <script src="../../../packages/layout/dist/index.js"></script>
    <script src="../../../packages/phosphor/dist/index.js"></script>
    <style>
        *{
            font-family: Roboto;
        }
    </style>
</head>
<body style="position:relative;width:100%;">
    <div id="placeholder" style="float:left;width:940px;"></div>
    <script src="data.js"></script>
    <script>
        const config = {
            rowHeight: 180,
            primaryFontSize: 20,
            secondaryFontSize: 14,
            primaryColor: "#494949",
            secondaryColor: "#DDD",
            whiteColor: "#FBFBFB",
        };

        const placeholder = document.getElementById("placeholder");

        placeholder.style.height = (g_data.length * config.rowHeight)+"px";

        window.g_grid = new window["@hpcc-js/layout"].Grid()
            .target("placeholder")
            .gutter(0)
            .surfaceShadow(false)
            .surfacePadding(0)
            .surfaceBorderWidth(0)
            ;

        g_data.forEach((row,i)=>{
            const subgrid = new window["@hpcc-js/layout"].Grid()
                .surfaceShadow(false)
                .surfaceBorderWidth(0)
                ;
            const descriptionWidget = getAttributeDescWidget(row);
            const breakdownWidget = getBreakdownWidget(row);
            const statsWidget = getStatsWidget(row);
            subgrid
                .setContent(0,0,descriptionWidget,undefined,1,1)
                .setContent(0,1,breakdownWidget,undefined,1,1)
                .setContent(0,2,statsWidget,undefined,1,1)
                ;
            g_grid
                .setContent(i,0,subgrid)
                ;
            function getAttributeDescWidget(row){
                return new window["@hpcc-js/other"].Html()
                    .html(`<span style="
                        padding-top:6px;
                        display:inline-block;
                        font-size:${config.primaryFontSize}px;
                    ">${row.attribute}</span><br/>
                    <span style="
                        color:${config.primaryColor};
                        padding:8px;
                        display:inline-block;
                        font-size:${config.secondaryFontSize}px;
                        margin-top:4px;
                        border:1px solid ${config.secondaryColor};
                        border-radius:4px;
                        background-color: ${config.whiteColor};
                    ">
                        <i style="
                            font-size:${config.secondaryFontSize}px;
                            color:${config.secondaryColor};
                        " class="fa ${row.best_attribute_type.slice(0,6) === "string" ? "fa-font" : "fa-hashtag"}"></i>
                        ${row.best_attribute_type}
                    </span>
                    `)
                    .overflowX("hidden")
                    .overflowY("hidden")
                    ;
            }
            function getBreakdownWidget(row){
                if(row.cardinality_breakdown.Row.length > 0){
                    let len = 0;
                    len = row.cardinality_breakdown.Row.length;
                    const _data = row.cardinality_breakdown.Row
                        .map(row=>[
                            row.value.trim(),
                            row.rec_count
                        ]);
                    if(len > 10){
                        return breakdownWidget(window["@hpcc-js/html"].BreakdownTable, _data);
                    } else if (len > 3) {
                        return breakdownWidget(window["@hpcc-js/chart"].Pie, _data);
                    } else {
                        return breakdownWidget(window["@hpcc-js/html"].StatsTable, _data);
                    }
                } else if(row.is_numeric) {
                    return quantileLineWidget([
                            ["0%",row.numeric_min],
                            ["25%",row.numeric_lower_quartile],
                            ["50%",row.numeric_median],
                            ["75%",row.numeric_upper_quartile],
                            ["100%",row.numeric_max],
                        ])
                        ;
                } else if (row.popular_patterns.Row.length > 0) {
                    let len = 0;
                    len = row.popular_patterns.Row.length;
                    const _data = row.popular_patterns.Row
                        .map(row=>[
                            row.data_pattern.trim(),
                            row.rec_count
                        ]);
                    if(len > 10){
                        return breakdownWidget(window["@hpcc-js/html"].BreakdownTable, _data);
                    } else if (len > 3) {
                        return breakdownWidget(window["@hpcc-js/chart"].Pie, _data);
                    } else {
                        return breakdownWidget(window["@hpcc-js/html"].StatsTable, _data);
                    }
                }
                function breakdownWidget(proto, _data){
                    return new proto()
                        .columns(["Cardinality",(row.cardinality).toString()])
                        .data(_data)
                        ;
                }
                function quantileLineWidget(_data){
                    const cardinalityCount = new window["@hpcc-js/html"].StyledTable()
                        .data([["Cardinality", row.cardinality]])
                        .tbodyColumnStyles_default([
                            {
                                "color": "#333",
                                "font-size": "26px",
                                "font-weight": "bold",
                                "text-align": "left",
                                "width": "auto",
                                "padding": "0px"
                            },
                            {
                                "color": "#333",
                                "font-size": "26px",
                                "font-weight": "bold",
                                "text-align": "right",
                                "width": "1%",
                                "padding": "0px"
                            }
                        ])
                        ;
            // case "linear":
            //     return d3CurveLinear;
            // case "step":
            //     return d3CurveStep;
            // case "step-before":
            //     return d3CurveStepBefore;
            // case "step-after":
            //     return d3CurveStepAfter;
            // case "basis":
            //     return d3CurveBasis;
            // case "bundle":
            //     return d3CurveBundle;
            // case "cardinal":
            //     return d3CurveCardinal;
            // case "catmullRom":
            //     return d3curveCatmullRom;
            // case "natural":
            //     return d3CurveNatural;
            // case "monotone":
                    const lineWidget = new window["@hpcc-js/chart"].Line()
                        .columns(["Quantiles", "Value"])
                        .data(_data)
                        .yAxisTickCount(3)
                        .yAxisHidden(true)
                        .interpolate("catmullRom")
                        .pointShape("circle")
                        .pointSize(6)
                        ;
                    return new window["@hpcc-js/layout"].Grid()
                        .gutter(0)
                        .surfaceShadow(false)
                        .surfacePadding(0)
                        .surfaceBorderWidth(0)
                        .setContent(0,0,cardinalityCount,undefined,1,1)
                        .setContent(1,0,lineWidget,undefined,3,1)
                        ;
                }
            }
            function getStatsWidget(row){
                const fillRate = row.fill_rate === 100 || row.fill_rate === 0 ? row.fill_rate : row.fill_rate.toFixed(1);
                if(row.is_numeric){
                    return new window["@hpcc-js/html"].StatsTable()
                        .data([
                            ["Filled", row.fill_count, fillRate+"%"],
                            ["Mean", row.numeric_mean, ""],
                            ["Std. Deviation", row.numeric_std_dev, ""],
                            ["", "", ""],
                            ["Quantiles", row.numeric_min, "Min"],
                            ["", row.numeric_lower_quartile, "25%"],
                            ["", row.numeric_median, "50%"],
                            ["", row.numeric_upper_quartile, "75%"],
                            ["", row.numeric_max, "Max"],
                        ])
                        ;
                } else if (row.popular_patterns.Row.length > 0) {
                    return new window["@hpcc-js/html"].StatsTable()
                        .data([
                            ["Filled", row.fill_count, fillRate+"%"],
                            ["Min Length", row.min_length, ""],
                            ["Avg Length", row.ave_length, ""],
                            ["Max Length", row.max_length, ""]
                        ])
                        ;
                }
                return getAttributeDescWidget(row);
            }
        })
        g_grid.render();
    </script>
</body>
</html>